"use strict";THREE.TextGeometry=function(e,t){t=t||{};var a=t.font;if(a instanceof THREE.Font==!1)return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new THREE.Geometry;var o=a.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),THREE.ExtrudeGeometry.call(this,o,t),this.type="TextGeometry"},THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype),THREE.TextGeometry.prototype.constructor=THREE.TextGeometry,THREE.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){try{return this.faces[this.face.toLowerCase()][this.weight][this.style]}catch(e){throw"The font "+this.face+" with "+this.weight+" weight and "+this.style+" style is missing."}},loadFace:function(e){var t=e.familyName.toLowerCase(),a=this;return a.faces[t]=a.faces[t]||{},a.faces[t][e.cssFontWeight]=a.faces[t][e.cssFontWeight]||{},a.faces[t][e.cssFontWeight][e.cssFontStyle]=e,a.faces[t][e.cssFontWeight][e.cssFontStyle]=e,e},drawText:function(e){var t,a=this.getFace(),o=this.size/a.resolution,r=0,n=String(e).split(""),s=n.length,i=[];for(t=0;s>t;t++){var c=new THREE.Path,l=this.extractGlyphPoints(n[t],a,o,r,c);r+=l.offset,i.push(l.path)}var d=r/2;return{paths:i,offset:d}},extractGlyphPoints:function(e,t,a,o,r){var n,s,i,c,l,d,g,p,h,u,m,_,f,y,v,w,E,b,x,T=[],k=THREE.ShapeUtils.b2,R=THREE.ShapeUtils.b3,H=t.glyphs[e]||t.glyphs["?"];if(H){if(H.o)for(c=H._cachedOutline||(H._cachedOutline=H.o.split(" ")),d=c.length,g=a,p=a,n=0;d>n;)switch(l=c[n++]){case"m":h=c[n++]*g+o,u=c[n++]*p,r.moveTo(h,u);break;case"l":h=c[n++]*g+o,u=c[n++]*p,r.lineTo(h,u);break;case"q":if(m=c[n++]*g+o,_=c[n++]*p,v=c[n++]*g+o,w=c[n++]*p,r.quadraticCurveTo(v,w,m,_),x=T[T.length-1])for(f=x.x,y=x.y,s=1,i=this.divisions;i>=s;s++){var z=s/i;k(z,f,v,m),k(z,y,w,_)}break;case"b":if(m=c[n++]*g+o,_=c[n++]*p,v=c[n++]*g+o,w=c[n++]*p,E=c[n++]*g+o,b=c[n++]*p,r.bezierCurveTo(v,w,E,b,m,_),x=T[T.length-1])for(f=x.x,y=x.y,s=1,i=this.divisions;i>=s;s++){var z=s/i;R(z,f,v,E,m),R(z,y,w,b,_)}}return{offset:H.ha*a,path:r}}}},THREE.FontUtils.generateShapes=function(e,t){t=t||{};var a=void 0!==t.size?t.size:100,o=void 0!==t.curveSegments?t.curveSegments:4,r=void 0!==t.font?t.font:"helvetiker",n=void 0!==t.weight?t.weight:"normal",s=void 0!==t.style?t.style:"normal";THREE.FontUtils.size=a,THREE.FontUtils.divisions=o,THREE.FontUtils.face=r,THREE.FontUtils.weight=n,THREE.FontUtils.style=s;for(var i=THREE.FontUtils.drawText(e),c=i.paths,l=[],d=0,g=c.length;g>d;d++)Array.prototype.push.apply(l,c[d].toShapes());return l},THREE.typeface_js={faces:THREE.FontUtils.faces,loadFace:THREE.FontUtils.loadFace},"undefined"!=typeof self&&(self._typeface_js=THREE.typeface_js),THREE.FloorGeometry=function(e,t){THREE.BufferGeometry.call(this),this.type="FloorGeometry",this.parameters={width:e,height:t};for(var a=new Float32Array(12),o=new Float32Array(12),r=new Float32Array(8),n=0,s=0;2>s;s++)for(var i=0;2>i;i++){var c=3*n;a[c]=i*e,a[c+1]=s*t,o[c+2]=1;var l=2*n;r[l]=i*e,r[l+1]=s*t,n++}var d=new Uint16Array(6);d[0]=0,d[1]=1,d[2]=2,d[3]=1,d[4]=3,d[5]=2,this.setIndex(new THREE.BufferAttribute(d,1)),this.addAttribute("position",new THREE.BufferAttribute(a,3)),this.addAttribute("normal",new THREE.BufferAttribute(o,3)),this.addAttribute("uv",new THREE.BufferAttribute(r,2))},THREE.FloorGeometry.prototype=Object.create(THREE.BufferGeometry.prototype),THREE.FloorGeometry.prototype.constructor=THREE.FloorGeometry,THREE.ReticleGeometry=function(e,t){THREE.BufferGeometry.call(this),this.type="ReticleGeometry",this.parameters={width:e,height:t};var a=new Float32Array(9),o=new Float32Array(9),r=new Float32Array(6),n=.1;a[0]=.5*e,a[1]=-t,a[2]=n,a[3]=0,a[4]=0,a[5]=n,a[3]=0,a[6]=e*-.5,a[7]=-t,a[8]=n,o[2]=1,o[5]=1,o[8]=1,r[0]=0,r[1]=0,r[1]=.5,r[2]=1,r[2]=1,r[3]=0;var s=new Uint16Array(3);s[0]=0,s[1]=1,s[2]=2,this.setIndex(new THREE.BufferAttribute(s,1)),this.addAttribute("position",new THREE.BufferAttribute(a,3)),this.addAttribute("normal",new THREE.BufferAttribute(o,3)),this.addAttribute("uv",new THREE.BufferAttribute(r,2))},THREE.ReticleGeometry.prototype=Object.create(THREE.BufferGeometry.prototype),THREE.ReticleGeometry.prototype.constructor=THREE.ReticleGeometry;var con={camera_offset:new THREE.Vector3,camera_size:12,coin_flip_time:.5,coin_velocity_damping:3,damage_time:1.5,light_tip_time:.25,light_cell_size:3,monster_normal_speed:2,monster_max_speed:7,monster_detect_radius:5,monster_chase_radius:6,monster_damage_radius:3,monster_attack_radius:1.5,monster_attack_delay:.5,monster_post_attack_delay:.8,monster_scare_radius:5,monster_alert_radius:20,quit_time:1.5,body_radius:.4,load_bar_size:new THREE.Vector2(5,1),fade_time:3,msg_time:2.5,glare_color:new THREE.Color(1,1,.7),level_names:["","FOYER","HALLWAY","STUDY","EAST WING","LIVING ROOM","YOU PULLED IT OFF!"],collision_directions:{right:new THREE.Vector2(.45,0),left:new THREE.Vector2(-.45,0),forward:new THREE.Vector2(0,.45),backward:new THREE.Vector2(0,-.45)},directions:{right:0,left:1,forward:2,backward:3},directions_with_diagonals:{right:0,left:1,forward:2,backward:3,right_forward:4,left_forward:5,right_backward:6,left_backward:7},max_capacity:4,masks:{wall:1,light:2,coin:4,player:8,door:16},monster_states:{normal:0,chase:1,attack:2,alert:3,hide:4},codes:{wall:[0,0,0],light:[255,0,0],coin:[0,255,0],player:[255,255,0],door:[0,255,255],monster:[255,0,255]},speed_multiplier:2,speed_max:5,audio:{coin:["snd/coin.wav"],coins:["snd/coins.wav"],howl:["snd/howl.wav"],whimper:["snd/whimper.wav"],door_close:["snd/door_close.wav"],monster_loop:["snd/monster_loop.wav"],menu_music:["snd/menu_music.mp3"],end_music:["snd/end_music.mp3"],attack:["snd/attack0.wav","snd/attack1.wav","snd/attack2.wav"],footstep:["snd/footstep0.wav","snd/footstep1.wav","snd/footstep2.wav","snd/footstep3.wav","snd/footstep4.wav","snd/footstep5.wav","snd/footstep6.wav"],light_tip:["snd/light_tip0.wav","snd/light_tip1.wav","snd/light_tip2.wav"],growl:["snd/growl0.wav","snd/growl1.wav"]}},state={font:null,level:0,grid:null,size:new THREE.Vector2,door:new THREE.Vector2,door_coins:1,bank_coins:0,coins:[],light_models:[],monsters:[],player:{alive:!1,damage_timer:0,pos:new THREE.Vector2,coins:[]}},graphics={overlay:null,load_bar:null,load_bar_background:null,logo:null,ui:null,texture_loader:new THREE.TextureLoader,model_loader:new THREE.JSONLoader,door_text:{bank_coins:0,door_coins:0,mesh:null},msg:null,msg_timer:0,quit_msg:0,scene:null,camera:null,renderer:null,scenery:[],flicker_lights:[],monsters:[],light_models:[],coins:[],player_coins:[],camera_pos:new THREE.Vector2,camera_pos_target:new THREE.Vector2(2,10),ground:null,player:null,reticle:null,player_light:null,level:{},geom:{light:null,player:null,monster:null,wall:null,coin:null},texture:{floor:null,wall:null,glare:null,logo:null}},global={quit_timer:0,load_total:0,load_count:0,level_timer:0,music:null,monster_loop_gain:null,audio_context:null,clock:new THREE.Clock,mouse:new THREE.Vector2,mouse_down:!1,button_down:!1,quit_key_down:!1,last_button_down:!1,last_mouse_down:!1,footstep_counter:0},func={};func.msg=function(e){graphics.msg_timer=0===state.level?0:con.msg_time,graphics.msg&&graphics.ui.remove(graphics.msg),e?(graphics.msg=func.create_text(e,2,graphics.ui),graphics.msg.material=new THREE.ShaderMaterial({vertexShader:document.getElementById("vertex_shader_unlit").textContent,fragmentShader:document.getElementById("fragment_shader_unlit").textContent}),graphics.msg.position.y=-3):graphics.msg=null},func.load_audio=function(e,t,a,o){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){global.audio_context.decodeAudioData(r.response,function(r){return r?(t[a]=r,void o()):void console.log("error decoding file data: "+e)},function(e){console.error("decodeAudioData error",e)})},r.onerror=function(){console.log("HTTP request failed: "+e)},r.send()},func.load_geom=function(e){global.load_total++,graphics.model_loader.load("geom/"+e+".js",function(t){graphics.geom[e]=t,global.load_count++,func.check_done_loading()})},func.on_keydown=function(e){27===e.keyCode&&(global.quit_key_down=!0)},func.on_keyup=function(e){27===e.keyCode&&(global.quit_key_down=!1)},func.init=function(){global.clock.start();var e=0;for(var t in con.level_names)graphics.level[e]=null,e++;window.addEventListener("resize",func.on_resize,!1),graphics.scene=new THREE.Scene,graphics.camera=new THREE.OrthographicCamera(-1,1,1,-1,.1,4*con.camera_size),graphics.camera.rotation.x=.2*Math.PI,graphics.camera.rotation.y=.08*Math.PI,graphics.camera.rotation.z=.08*Math.PI,con.camera_offset=graphics.camera.getWorldDirection().multiplyScalar(-con.camera_size),graphics.ui=new THREE.Object3D,graphics.ui.quaternion.setFromEuler(graphics.camera.rotation),graphics.scene.add(graphics.ui),graphics.overlay=new THREE.Sprite(new THREE.SpriteMaterial({color:0})),graphics.overlay.position.z=-1,graphics.ui.add(graphics.overlay),graphics.overlay.visible=!1,graphics.load_bar=new THREE.Sprite(new THREE.SpriteMaterial({color:16777215})),graphics.load_bar.position.z=-1,graphics.load_bar.scale.set(0,con.load_bar_size.y,1),graphics.ui.add(graphics.load_bar),graphics.load_bar_background=new THREE.Sprite(new THREE.SpriteMaterial({color:6710886})),graphics.load_bar_background.position.z=-2,graphics.load_bar_background.scale.set(con.load_bar_size.x,con.load_bar_size.y,1),graphics.ui.add(graphics.load_bar_background),graphics.renderer=new THREE.WebGLRenderer({antialias:!0}),graphics.renderer.setSize(window.innerWidth,window.innerHeight),graphics.renderer.gammaInput=!0,graphics.renderer.gammaOutput=!0,graphics.renderer.setClearColor(0),graphics.renderer.setPixelRatio(window.devicePixelRatio),document.body.appendChild(graphics.renderer.domElement),func.on_resize();for(var a in graphics.geom)func.load_geom(a);for(var o in graphics.texture)global.load_total++,graphics.texture[o]=graphics.texture_loader.load("texture/"+o+".png",function(e){e.minFilter=e.magFilter=THREE.NearestFilter,global.load_count++,func.check_done_loading()},func.error);for(var r in graphics.level)global.load_total++,graphics.level[r]=graphics.texture_loader.load("lvl/"+r+".png",function(){global.load_count++,func.check_done_loading()},func.error);global.load_total++,(new THREE.FontLoader).load("helvetiker_bold.typeface.js",function(e){graphics.font=e,global.load_count++,func.check_done_loading()});var n=window.AudioContext||window.webkitAudioContext;global.audio_context=new n;for(var s in con.audio)for(var i=con.audio[s],e=0;e<i.length;e++){var c=i[e];global.load_total++,func.load_audio(c,i,e,function(){global.load_count++,func.check_done_loading()})}$(window).on("resize",func.on_resize),window.focus(),$(document).on("keydown",func.on_keydown),$(document).on("keyup",func.on_keyup),$(document).on("mousedown",func.on_mousedown),$(document).on("mousemove",func.on_mousemove),$(document).on("mouseup",func.on_mouseup),$(document).on("touchstart",func.on_mousedown),$(document).on("touchmove",func.on_mousemove),$(document).on("touchend",func.on_mouseup),func.update()},func.audio=function(e,t,a){if(!("undefined"!=typeof a&&e.time_last_played&&new Date-e.time_last_played>1e3*a)&&("undefined"==typeof t&&(t=1),t>0)){var o=global.audio_context.createBufferSource();if(e.length>1){var r;do r=Math.floor(Math.random()*e.length);while(r===e.last_played);e.last_played=r,o.buffer=e[r]}else o.buffer=e[0];e.time_last_played=new Date;var n=global.audio_context.createGain();o.connect(n),n.connect(global.audio_context.destination),n.gain.value=t,o.start(0)}},func.check_done_loading=function(){if(global.load_count<global.load_total)return!1;graphics.ui.remove(graphics.load_bar),graphics.ui.remove(graphics.load_bar_background),graphics.load_bar=null,graphics.load_bar_background=null,graphics.quit_msg=func.create_text("Hold to quit",2,graphics.ui),graphics.quit_msg.material=new THREE.ShaderMaterial({vertexShader:document.getElementById("vertex_shader_unlit").textContent,fragmentShader:document.getElementById("fragment_shader_unlit").textContent}),graphics.quit_msg.position.y=3,graphics.quit_msg.visible=!1;var e=global.audio_context.createBufferSource();e.buffer=con.audio.monster_loop[0],e.loop=!0;var t=global.audio_context.createGain();return e.connect(t),t.connect(global.audio_context.destination),t.gain.value=0,global.monster_loop_gain=t,e.start(0),graphics.geom.glares=new THREE.Geometry,graphics.geom.glares.vertices.push(new THREE.Vector3(.8,0,2.5)),graphics.geom.glares.vertices.push(new THREE.Vector3(-.8,0,2.5)),graphics.geom.glares.vertices.push(new THREE.Vector3(0,.8,2.5)),graphics.geom.glares.vertices.push(new THREE.Vector3(0,-.8,2.5)),graphics.player=func.add_mesh(graphics.geom.player,16711680),graphics.player_light=new THREE.PointLight(11154193,1,5),graphics.player_light.position.set(0,0,1.5),graphics.player.add(graphics.player_light),graphics.reticle=func.add_mesh(new THREE.ReticleGeometry(.4,.6),16711680),graphics.player.add(graphics.reticle),func.load_level(state.level),!0},func.on_mousedown=function(e){e.touches?1===e.touches.length&&global.mouse.set(e.touches[0].pageX,e.touches[0].pageY):global.mouse.set(e.clientX,e.clientY),global.mouse_down=!0,e.preventDefault()},func.on_mousemove=function(e){e.touches?1===e.touches.length&&global.mouse.set(e.touches[0].pageX,e.touches[0].pageY):global.mouse.set(e.clientX,e.clientY),e.preventDefault()},func.on_mouseup=function(e){global.mouse_down=!1,e.preventDefault()},func.create_text=function(e,t,a){var o=1===e.length?1:1/Math.sqrt(e.length),r=new THREE.TextGeometry(e,{size:t*o,height:0,curveSegments:2,font:graphics.font,weight:"bold",style:"normal",bevelThickness:0,bevelSize:0,bevelEnabled:!1,material:0,extrudeMaterial:0}),n=func.add_mesh(r,16711680,null,a);return r.computeBoundingBox(),n.position.x=-.05-.5*(r.boundingBox.max.x-r.boundingBox.min.x),n.position.y=-.5*(r.boundingBox.max.y-r.boundingBox.min.y),n},func.music=function(e){var t=global.audio_context.createBufferSource();return t.buffer=e[0],t.loop=!0,t.connect(global.audio_context.destination),t.start(0),t},func.refresh_door_text=function(){if(graphics.door_text.mesh&&graphics.door.remove(graphics.door_text.mesh),state.door_coins>0){var e=func.create_text(state.bank_coins+" / "+state.door_coins,1,graphics.door);e.position.z=1.05,graphics.door_text.mesh=e}graphics.door_text.bank_coins=state.bank_coins,graphics.door_text.door_coins=state.door_coins},func.monster_spawn=function(e){state.monsters.push({pos:e.clone(),path:[],state:con.monster_states.normal,timer:0,timer2:0});var t=func.add_mesh(graphics.geom.monster,0);t.position.set(e.x,e.y,0),graphics.scenery.push(t),graphics.monsters.push(t);var a=func.create_text("!",1,t);a.material=new THREE.ShaderMaterial({vertexShader:document.getElementById("vertex_shader_unlit").textContent,fragmentShader:document.getElementById("fragment_shader_unlit").textContent}),a.rotation.copy(graphics.camera.rotation),a.position.z=1.5},func.load_level=function(e){state.player.coins.length=0,state.grid=null,state.coins.length=0,state.bank_coins=0,state.light_models.length=0,state.monsters.length=0,graphics.logo=null,graphics.light_models.length=0,graphics.monsters.length=0,graphics.door_text.mesh=null,global.music&&(global.music.stop(),global.music=null),graphics.ground&&(graphics.scene.remove(graphics.ground),graphics.ground=null);for(var t=0;t<graphics.scenery.length;t++)graphics.scenery[t].parent.remove(graphics.scenery[t]);graphics.scenery.length=0,graphics.flicker_lights.length=0,state.level=e,state.player.alive=0!==state.level&&state.level!==con.level_names.length-1,global.level_timer=0;var a=graphics.level[state.level];state.size.x=a.image.width,state.size.y=a.image.height,state.grid=new Array(state.size.x);for(var t=0;t<state.grid.length;t++)state.grid[t]=new Array(state.size.y);var o=document.createElement("canvas");o.width=a.image.width,o.height=a.image.height;var r=o.getContext("2d");r.drawImage(a.image,0,0,a.image.width,a.image.height,0,0,a.image.width,a.image.height);for(var n=r.getImageData(0,0,a.image.width,a.image.height),s=function(e,t){return n.data[e]===t[0]&&n.data[e+1]===t[1]&&n.data[e+2]===t[2]},i=new THREE.Vector2,c=0;c<state.size.x;c++)for(var l=0;l<state.size.y;l++){var d={mask:0,id:0},g=4*(c+(state.size.y-1-l)*state.size.x);if(i.set(c+.5,l+.5),s(g,con.codes.wall)){var p=func.add_mesh(graphics.geom.wall,16777215);p.material.map=graphics.texture.wall,graphics.scenery.push(p),p.position.set(i.x,i.y,0),d.mask=con.masks.wall}else if(s(g,con.codes.light)){state.light_models.push({pos:i.clone(),on:!0,anim_time:con.light_tip_time,anim_dir:0}),d.mask=con.masks.light,d.id=state.light_models.length-1;var h=func.add_mesh(graphics.geom.light,13421636);graphics.scenery.push(h),h.position.set(i.x,i.y,0),graphics.light_models.push(h);var u=new THREE.PointsMaterial({size:35,sizeAttenuation:!1,map:graphics.texture.glare,transparent:!0});u.color.copy(con.glare_color);var m=new THREE.Points(graphics.geom.glares,u);h.add(m);var _=new THREE.PointLight(14522743,1,5);_.position.set(0,0,3),graphics.flicker_lights.push(_),h.add(_)}else if(s(g,con.codes.monster))func.monster_spawn(i);else if(s(g,con.codes.player))state.player.pos.copy(i);else if(n.data[g]<255&&n.data[g+1]===con.codes.door[1]&&n.data[g+2]===con.codes.door[2]){graphics.door=new THREE.Object3D,graphics.door.position.set(i.x,i.y,0),graphics.scene.add(graphics.door),graphics.scenery.push(graphics.door),state.door.set(c,l),state.door_coins=n.data[g];var _=new THREE.PointLight(16777215,1,5);_.position.set(0,0,3),graphics.door.add(_),d.mask=con.masks.door,func.refresh_door_text()}else s(g,con.codes.coin)&&state.coins.push({pos:i.clone(),velocity:new THREE.Vector2});state.grid[c][l]=d}if(graphics.texture.floor.wrapS=THREE.RepeatWrapping,graphics.texture.floor.wrapT=THREE.RepeatWrapping,graphics.ground=func.add_mesh(new THREE.FloorGeometry(state.size.x,state.size.y),16768460),graphics.ground.material.map=graphics.texture.floor,state.player.alive?graphics.camera_pos_target.copy(state.player.pos):graphics.camera_pos_target.set(.5*state.size.x,4),graphics.camera_pos.copy(graphics.camera_pos_target),func.msg(con.level_names[state.level]),0===state.level){var f=new THREE.SpriteMaterial({map:graphics.texture.logo,color:16777215});graphics.logo=new THREE.Sprite(f),graphics.scenery.push(graphics.logo),graphics.ui.add(graphics.logo),global.music=func.music(con.audio.menu_music)}else state.level===con.level_names.length-1?global.music=func.music(con.audio.end_music):func.audio(con.audio.door_close)},func.coord=function(e){return new THREE.Vector2(Math.floor(e.x),Math.floor(e.y))},func.cell_hash=function(e){return e.x+e.y*state.size.x},func.random_goal=function(e,t,a){var o=[],r={},n=[];for(n.push(func.coord(e));n.length>0;){var s=n.pop(0);r[func.cell_hash(s)]=!0;for(var i in con.directions){var c=s.clone();if(func.move_dir(c,con.directions[i]),c.x>=0&&c.x<state.size.x&&c.y>=0&&c.y<state.size.y&&c.clone().sub(e).length()<t){var l=func.cell_hash(c);r[l]||0!==state.grid[c.x][c.y].mask||(n.push(c),("undefined"==typeof a||a(c))&&o.push(c))}}}return 0===o.length?null:o[Math.floor(Math.random()*o.length)]},func.astar=function(e,t,a){e=func.coord(e),a.length=0;var o=[];o.push(e);var r={},n={},s={},i=func.cell_hash(e);r[i]=0,s[i]=t.clone().sub(e).length();for(var c=func.cell_hash(func.coord(t)),l=function(e,t){var a=func.cell_hash(e),o=func.cell_hash(t),n=r[a]+s[a],i=r[o]+s[o];return i-n};o.length>0;){o.sort(l);var d=o.pop(0),g=r[func.cell_hash(d)];for(var p in con.directions){var h=d.clone();if(func.move_dir(h,con.directions[p]),h.x>=0&&h.x<state.size.x&&h.y>=0&&h.y<state.size.y&&0===state.grid[h.x][h.y].mask){var u=func.cell_hash(h),m=r[u];if(u===c){a.push(t);for(var _=d;_;)a.splice(0,0,_),_=n[func.cell_hash(_)];a.splice(0,1);for(var f=0;f<a.length-1;f++){var d=a[f],y=!1;for(var p in con.directions_with_diagonals){var h=d.clone();if(func.move_dir(h,con.directions[p]),h.x>=0&&h.x<state.size.x&&h.y>=0&&h.y<state.size.y&&0!==state.grid[h.x][h.y].mask){y=!0;break}}y||(a.splice(f,1),f--)}return!0}var v=g+1;"undefined"==typeof m?(n[u]=d,r[u]=v,s[u]=t.clone().sub(h).length(),o.push(h)):m>g+1&&(n[u]=d,r[u]=v)}}}return!1},func.add_mesh=function(e,t,a,o){var r;if(a){for(var n=new Array(a.length),s=new THREE.Color(t),i=0;i<a.length;i++)n[i]=new THREE.MeshPhongMaterial({color:a[i].color,specular:0}),n[i].color.multiply(s);r=new THREE.MeshFaceMaterial(n)}else r=new THREE.MeshPhongMaterial({color:t,specular:0});var c=new THREE.Mesh(e,r);return c.castShadow=!0,c.receiveShadow=!0,o?o.add(c):graphics.scene.add(c),c},func.flicker_light=function(e,t,a){"undefined"==typeof a&&(a=1);var o=e.intensity=a*func.flicker(t);e.distance=5*o},func.flicker=function(e,t){return"undefined"==typeof t&&(t=.02),1-t+Math.sin(40*(global.clock.getElapsedTime()+e))*t},func.collides=function(e,t,a){return e.x>t&&e.x<t+1&&e.y>a&&e.y<a+1},func.closest_corner=function(e,t,a){for(var o=1e3,r=new THREE.Vector2,n=new THREE.Vector2,s=t;t+2>s;s++)for(var i=a;a+2>i;i++){var c=n.set(s,i).sub(e).length();o>c&&(r.set(s,i),o=c)}return{corner:r,distance:o}},func.move_dir=function(e,t){switch(t){case con.directions.right:e.x+=1;break;case con.directions.left:e.x-=1;break;case con.directions.forward:e.y+=1;break;case con.directions.backward:e.y-=1;break;case con.directions.right_forward:e.x+=1,e.y+=1;break;case con.directions.left_forward:e.x-=1,e.y+=1;break;case con.directions.right_backward:e.x+=1,e.y-=1;break;case con.directions.left_backward:e.x-=1,e.y-=1}},func.move_body=function(e,t,a,o,r,n){"undefined"==typeof o&&(o=con.speed_max),"undefined"==typeof r&&(r=16777215);var s=t.length();s>o&&(t.multiplyScalar(o/s),s=o);var i=t.clone();i.multiplyScalar(a),e.add(i);var c=0;if(s>0)for(var l=func.coord(e),d=l.x-1;d<l.x+2;d++)if(!(0>d||d>=state.size.x))for(var g=l.y-1;g<l.y+2;g++)if(!(0>g||g>=state.size.y)){var p=state.grid[d][g];if(p.mask&r){var h,u=!1;if(t.x>0&&func.collides(e.clone().add(con.collision_directions.right),d,g)&&(e.x=d-con.body_radius,t.x=0,c|=p.mask,u=!0,h=con.directions.right),t.x<0&&func.collides(e.clone().add(con.collision_directions.left),d,g)&&(e.x=d+1+con.body_radius,t.x=0,c|=p.mask,u=!0,h=con.directions.left),t.y>0&&func.collides(e.clone().add(con.collision_directions.forward),d,g))e.y=g-con.body_radius,t.y=0,c|=p.mask,u=!0,h=con.directions.forward;else if(t.y<0&&func.collides(e.clone().add(con.collision_directions.backward),d,g))e.y=g+1+con.body_radius,t.y=0,c|=p.mask,u=!0,h=con.directions.backward;else{var m=func.closest_corner(e,d,g);if(m.distance<con.body_radius){var _=e.clone().sub(m.corner);_.normalize();var f=_.clone();f.multiplyScalar(con.body_radius-m.distance),e.add(f);var y=t.dot(_);_.multiplyScalar(y),t.add(_),c|=p.mask,u=!0;var v=new THREE.Vector2(d,g).sub(e);h=Math.abs(v.x)>Math.abs(v.y)?v.x<0?con.directions.left:con.directions.right:v.y<0?con.directions.backward:con.directions.forward}}if(u&&n&&p.mask&con.masks.light){var w=state.light_models[p.id];if(w.on){for(var E=new THREE.Vector2(d,g),b=!1,x=0;x<con.light_cell_size-1;x++)if(func.move_dir(E,h),E.x<0||E.x>=state.size.x||E.y<0||E.y>=state.size.y||0!==state.grid[E.x][E.y].mask){b=!0;break}if(!b){state.level<3&&func.msg("SSHHH!"),func.audio(con.audio.light_tip),E.set(d,g);for(var x=0;x<con.light_cell_size-1;x++){func.move_dir(E,h);var T=state.grid[E.x][E.y];T.mask=con.masks.light,T.id=p.id}w.on=!1,w.anim_time=0,w.anim_dir=h}}}}}return c},func.monster_move=function(e,t,a){if(e.path.length>0){var o=e.path[0],r=o.clone().add(new THREE.Vector2(.5,.5)).sub(e.pos);if(r.length()<.25)e.path.splice(0,1),func.monster_move(e,t,a);else{r.normalize(),r.multiplyScalar(t);var n=func.move_body(e.pos,r,a,t,16777215,!1);0!==n&&func.astar(e.pos,e.path[e.path.length-1],e.path)}}},func.monster_check_attack=function(e){state.player.alive&&e.pos.clone().sub(state.player.pos).length()<con.monster_attack_radius&&(e.state=con.monster_states.attack,e.timer=con.monster_attack_delay,e.path.length=0,func.audio(con.audio.growl))},func.cell_is_far_from_player=function(e){return e.clone().sub(state.player.pos).length()>12},func.cell_is_very_far_from_player=function(e){return e.clone().sub(state.player.pos).length()>20},func.gamepad=function(){if(navigator.getGamepads){var e=navigator.getGamepads();if(e.length>0){var t=e[0];if(t&&t.connected)return t}}return null},func.update=function(){requestAnimationFrame(func.update);var e=global.clock.getDelta();if(global.load_count<global.load_total)graphics.load_bar.scale.x=con.load_bar_size.x*(global.load_count/global.load_total),graphics.load_bar.position.x=con.load_bar_size.x*-.5+.5*graphics.load_bar.scale.x;else{global.button_down=!1;var t=func.gamepad();if(t)for(var a=0;a<t.buttons.length;a++)if(t.buttons[a].pressed){global.button_down=!0;break}if(global.level_timer+=e,state.player.damage_timer>0&&(state.player.damage_timer-=e),state.grid&&state.player.alive){var o=new THREE.Vector2;if(global.mouse_down){var r=graphics.camera.projectionMatrix.clone();r.multiply(graphics.camera.matrixWorldInverse);var n=new THREE.Matrix4;n.getInverse(r);var s=global.mouse.x/window.innerWidth*2-1,i=2*(1-global.mouse.y/window.innerHeight)-1,c=[s,i,0,s,i,1];n.applyToVector3Array(c);var l=new THREE.Vector3(c[0],c[1],c[2]),d=new THREE.Vector3(c[3],c[4],c[5]),g=l.z/(l.z-d.z),p=new THREE.Vector2(l.x+(d.x-l.x)*g,l.y+(d.y-l.y)*g);o.copy(p).sub(state.player.pos)}if(t){var h=new THREE.Vector2(t.axes[0],-t.axes[1]);h.length()>.1&&o.copy(h).multiplyScalar(con.speed_max/Math.max(1,h.length()))}if(o.lengthSq()>0){graphics.player.rotation.z=-Math.atan2(o.x,o.y);var u=.6+.4*(con.max_capacity-state.player.coins.length)/con.max_capacity,m=con.speed_max*u;graphics.reticle.visible=!0,graphics.reticle.position.y=Math.min(con.speed_max/con.speed_multiplier,Math.max(1,o.length())),o.multiplyScalar(con.speed_multiplier*u);var _;_=state.bank_coins<state.door_coins?16777215:~con.masks.door;var f=func.move_body(state.player.pos,o,e,m,_,!0);if(f&con.masks.door&&state.player.coins.length>0){func.audio(con.audio.coins),state.bank_coins+=state.player.coins.length,state.player.coins.length=0;var y=func.random_goal(state.player.pos,50,func.cell_is_very_far_from_player);null!==y&&(func.monster_spawn(y),func.audio(con.audio.growl),func.msg("+1 MONSTER"))}var v=o.length();v>0&&(global.footstep_counter+=Math.max(1,v)*e,global.footstep_counter>1.5&&(func.audio(con.audio.footstep,Math.max(.1,v/m*.4)),global.footstep_counter=0)),Math.floor(state.player.pos.x)===state.door.x&&Math.floor(state.player.pos.y)===state.door.y&&state.bank_coins>=state.door_coins&&(state.level++,func.load_level(state.level))}else graphics.reticle.visible=!1}for(graphics.player.position.set(state.player.pos.x,state.player.pos.y,0),func.flicker_light(graphics.player_light,0,1.2);graphics.coins.length<state.coins.length;)graphics.coins.push(func.add_mesh(graphics.geom.coin,16776960));for(var a=0;a<state.coins.length;a++){var w=state.coins[a],E=graphics.coins[a],b=w.pos.clone().sub(state.player.pos);if(w.velocity.lengthSq()>0){var x=w.velocity.clone();x.normalize(),w.velocity.sub(x.multiplyScalar(Math.min(e*con.coin_velocity_damping,w.velocity.length()))),func.move_body(w.pos,w.velocity,e,2*con.speed_max,16777215,!1)}if(state.player.alive&&b.length()<1)if(state.player.coins.length<con.max_capacity&&state.player.damage_timer<=0)func.audio(con.audio.coin),state.player.coins.push({pos:w.pos,anim_time:0}),state.coins.splice(a,1),a--;else{b.normalize();var T=o.dot(b);if(T>0){var k=b.clone();k.multiplyScalar(T),func.move_body(w.pos,k,e),E.position.set(w.pos.x,w.pos.y,0)}}else E.position.set(w.pos.x,w.pos.y,0)}for(;graphics.coins.length>state.coins.length;)graphics.scene.remove(graphics.coins[graphics.coins.length-1]),graphics.coins.length--;for(;graphics.player_coins.length<state.player.coins.length;){var w=func.add_mesh(graphics.geom.coin,16776960);graphics.player_coins.push(w)}for(var R=new THREE.Vector3,a=0;a<state.player.coins.length;a++){var w=state.player.coins[a],E=graphics.player_coins[a];if(R.set(state.player.pos.x,state.player.pos.y,1+.3*a),w.anim_time<con.coin_flip_time){w.anim_time+=e;var H=w.anim_time/con.coin_flip_time;E.position.set(w.pos.x,w.pos.y,0),E.position.lerp(R,H),E.position.z+=2*Math.sin(H*Math.PI),E.rotation.set((1-H)*Math.PI*4,0,0)}else E.position.copy(R),E.rotation.set(0,0,0)}for(;graphics.player_coins.length>state.player.coins.length;)graphics.scene.remove(graphics.player_coins[graphics.player_coins.length-1]),graphics.player_coins.length--;for(var z=-1,a=0;a<state.monsters.length;a++){var S=state.monsters[a],E=graphics.monsters[a],M=S.pos.clone().sub(graphics.camera_pos).length();switch((0>z||z>M)&&(z=M),S.state){case con.monster_states.normal:if(0===S.path.length&&(S.timer-=e,S.timer<0&&(func.astar(S.pos,func.random_goal(S.pos,10),S.path),S.timer=.5+3*Math.random())),func.monster_move(S,con.monster_normal_speed,e),state.player.alive){if(state.player.pos.clone().sub(S.pos).length()<con.monster_detect_radius){var F=[];func.astar(S.pos,state.player.pos,F),F.length<con.monster_detect_radius+1?S.timer2+=e:S.timer2=0}else S.timer2=0;S.timer2>1&&(S.state=con.monster_states.chase,S.path.length=0)}else S.timer2=0;func.monster_check_attack(S);break;case con.monster_states.chase:if(S.timer-=e,S.timer<0||0===S.path.length){S.timer=.5;var G=!1;if(state.player.alive&&state.player.pos.clone().sub(S.pos).length()<con.monster_chase_radius){var F=[];func.astar(S.pos,state.player.pos,F),F.length<con.monster_chase_radius+1?S.path=F:G=!0}else 0===S.path.length&&(G=!0);G&&(S.state=con.monster_states.normal,S.path.length=0,S.timer=3)}S.path.length>0&&(func.monster_move(S,con.monster_max_speed,e),func.monster_check_attack(S));break;case con.monster_states.attack:var A=S.timer;if(S.timer-=e,S.timer<0)if(A>=0){if(func.audio(con.audio.attack),state.player.alive&&state.player.pos.clone().sub(S.pos).length()<con.monster_damage_radius)if(state.player.coins.length>0){state.player.damage_timer=con.damage_time;for(var V=0;V<state.player.coins.length;V++){var I=func.random_goal(state.player.pos,2);state.coins.push({pos:I,velocity:I.clone().sub(state.player.pos).multiplyScalar(4)})}state.player.coins.length=0,func.audio(con.audio.coins)}else state.player.alive=!1,func.msg("YOU DIED"),S.rotation=0,S.state=con.monster_states.normal,S.path.length=0,S.timer=3}else S.timer<-con.monster_post_attack_delay&&(S.rotation=0,S.state=state.player.alive?con.monster_states.chase:con.monster_states.normal,S.timer=0,S.path.length=0);break;case con.monster_states.alert:var q=!1;if(state.player.alive&&state.player.pos.clone().sub(S.pos).length()<con.monster_detect_radius){var F=[];func.astar(S.pos,state.player.pos,F),F.length<con.monster_detect_radius+1&&(q=!0,S.state=con.monster_states.chase,S.timer=0,S.path.length=0)}q||0!==S.path.length||(S.state=con.monster_states.normal,S.timer=3),func.monster_move(S,con.monster_max_speed,e),func.monster_check_attack(S);break;case con.monster_states.hide:0===S.path.length?(S.state=con.monster_states.normal,S.timer=3):func.monster_move(S,con.monster_max_speed,e)}E.position.set(S.pos.x,S.pos.y,0),E.children[0].visible=S.state===con.monster_states.hide,S.state===con.monster_states.attack?(E.rotation.z=S.timer>0?0:S.timer/-con.monster_post_attack_delay*Math.PI*2,E.scale.set(con.monster_damage_radius/.77,con.monster_damage_radius/.77,1)):(E.rotation.z=0,E.scale.set(1,1,1))}global.monster_loop_gain.gain.value=z>0?Math.max(0,.25*(1-z/(.75*con.camera_size))):0,!graphics.door||graphics.door_text.bank_coins===state.bank_coins&&graphics.door_text.door_coins===state.door_coins||func.refresh_door_text();for(var a=0;a<state.light_models.length;a++){var B=state.light_models[a],E=graphics.light_models[a];if(B.on){var P=E.children[0];P.material.color.copy(con.glare_color),P.material.color.multiplyScalar(func.flicker(a,.05))}if(B.anim_time<con.light_tip_time){B.anim_time=Math.min(B.anim_time+e,con.light_tip_time);var H=B.anim_time/con.light_tip_time;

switch(B.anim_dir){case con.directions.right:E.rotation.set(0,.5*Math.PI*H,0);break;case con.directions.left:E.rotation.set(0,Math.PI*-.5*H,0);break;case con.directions.forward:E.rotation.set(Math.PI*-.5*H,0,0);break;case con.directions.backward:E.rotation.set(.5*Math.PI*H,0,0)}if(1==H){var C=E.children[1];C.color.set(0,0,0);var P=E.children[0];E.remove(P);for(var V=0;V<state.monsters.length;V++){var S=state.monsters[V],M=S.pos.clone().sub(B.pos).length();if(M<con.monster_scare_radius){var F=[];func.astar(S.pos,func.random_goal(B.pos,30,func.cell_is_far_from_player),F),F.length>0&&(func.audio(con.audio.whimper,1,10),S.state=con.monster_states.hide,S.path=F)}else if(S.state===con.monster_states.normal&&M<con.monster_alert_radius){var F=[];func.astar(S.pos,func.random_goal(B.pos,2),F),F.length>0&&(func.audio(con.audio.howl,1,10),S.state=con.monster_states.alert,S.path=F)}}}}}state.player.alive&&graphics.camera_pos_target.copy(state.player.pos),graphics.camera_pos.lerp(graphics.camera_pos_target,10*e),graphics.camera.position.set(graphics.camera_pos.x,graphics.camera_pos.y,0).add(con.camera_offset);for(var a=0;a<graphics.flicker_lights.length;a++)func.flicker_light(graphics.flicker_lights[a],a);0!==state.level&&state.level!==con.level_names.length-1&&(global.quit_key_down||global.button_down)?(graphics.quit_msg.visible=!0,global.quit_timer+=e,global.quit_timer>con.quit_time&&func.load_level(0)):(global.quit_timer=0,graphics.quit_msg.visible=!1),graphics.msg_timer>0?(graphics.msg_timer-=e,state.player.alive&&graphics.msg_timer<=0&&(graphics.ui.remove(graphics.msg),graphics.msg=null)):!state.player.alive&&(global.mouse_down&&!global.last_mouse_down||global.button_down&&!global.last_button_down)&&func.load_level(0===state.level?1:state.level===con.level_names.length-1?0:state.level),graphics.player.visible=state.player.alive?state.player.damage_timer<=0?!0:state.player.damage_timer%.1<.05:!1,global.last_mouse_down=global.mouse_down,global.last_button_down=global.button_down,global.level_timer<con.fade_time?(graphics.overlay.visible=!0,graphics.overlay.scale.set(graphics.camera.right-graphics.camera.left,graphics.camera.top-graphics.camera.bottom,1),graphics.overlay.material.opacity=1-global.level_timer/con.fade_time):graphics.overlay.visible=!1}graphics.ui.position.copy(graphics.camera.position).add(con.camera_offset.clone().multiplyScalar(-.1));var U=window.innerWidth<window.innerHeight?window.innerWidth:window.innerHeight,W=con.camera_size/U;if(graphics.logo){var O=graphics.texture.logo.image.width/graphics.texture.logo.image.height;graphics.logo.scale.set(.01*O*U,.01*U,1)}graphics.camera.left=-.5*window.innerWidth*W,graphics.camera.right=.5*window.innerWidth*W,graphics.camera.top=.5*window.innerHeight*W,graphics.camera.bottom=-.5*window.innerHeight*W,graphics.camera.updateProjectionMatrix(),graphics.renderer.render(graphics.scene,graphics.camera)},func.on_resize=function(){graphics.renderer.setSize(window.innerWidth,window.innerHeight)},$(document).ready(function(){func.init()});